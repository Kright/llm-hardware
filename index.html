<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <style>
        body {
            font-size: 20px;
        }

        button {
            font-size: 30px;
            margin: 20px;
        }
    </style>
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.9/purify.min.js"></script>

    <script>
        let queue = {}, scores = {}, opt;
        if (!localStorage.scores) localStorage.scores = "";

        async function init() {
            const text = await fetch("./out-results.json.log").then(res => res.text());
            const prompts = await fetch("./in-prompts.json").then(res => res.json());

            for (let line of (text + "\n" + localStorage.scores).split("\n")) {
                if (!line) continue;
                const { model, task_id, result, score } = JSON.parse(line);
                const key = model + "," + task_id;

                if (result) {
                    const answer = result?.choices?.[0]?.message?.content || result?.message?.content;
                    const answerParts = answer.split("</think>");

                    queue[key] = { question: prompts[task_id], answer: answerParts[1] || answerParts[0] };
                }

                if (score) scores[key] = score;
            }

            for (let key in scores) {
                delete queue[key];
            }

            render();
        }

        init();

        function render() {
            const opts = Object.entries(queue);
            opt = opts[Math.floor(Math.random() * opts.length)];

            const text = opt[1].question + "\n\n-------\n\n" + opt[1].answer;

            document.body.innerHTML = DOMPurify.sanitize(marked.parse(text)) +
                '<br/><button onclick="score(true)">ðŸŸ¢ OK</button><button onclick="score(false)">ðŸ”´ trash</button><button onclick="save()">save</button>';
        }

        function score(ok) {
            const [model, id] = opt[0].split(",");
            localStorage.scores += JSON.stringify({ model, task_id: +id, score: ok ? "ok" : "trash", "unixtime": Date.now() / 1000 }) + "\n";

            delete queue[opt[0]];
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function save() {
            document.body.innerText = localStorage.scores;
            localStorage.scores = "";
        }
    </script>
</body>

</html>